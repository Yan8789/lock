<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 æ™ºæ…§é–€ç¦</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; background: #f0f2f5; color: #333; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card-admin { border-left: 5px solid #dc3545; display: none; } /* é è¨­éš±è—å¾Œå° */
        .card-user { border-left: 5px solid #28a745; }
        h2 { margin-top: 0; font-size: 1.2em; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .mode-badge { padding: 5px 10px; border-radius: 15px; font-size: 0.8em; font-weight: bold; background: #eee; cursor: pointer;}
        
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; margin: 5px 0; width: 100%; transition: 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background: #007bff; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-outline { background: transparent; border: 1px solid #007bff; color: #007bff; }
        .btn-big-toggle { font-size: 1.2em; font-weight: bold; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        .tag { display: inline-block; background: #e9ecef; padding: 5px 10px; border-radius: 15px; margin: 3px; font-size: 0.9em; border: 1px solid #ced4da;}
        
        #confirm-modal { display: none; background: #fff3cd; color: #856404; padding: 15px; border-radius: 8px; border: 1px solid #ffeeba; animation: blink 1s infinite; margin-bottom: 20px;}
        @keyframes blink { 50% { border-color: transparent; } }

        /* è—èŠ½æƒæåˆ—è¡¨ */
        #bt-scan-list { margin-top: 10px; max-height: 200px; overflow-y: auto; display: none; border: 1px solid #eee; }
        .bt-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; }
        .bt-item:hover { background: #f8f9fa; }
    </style>
</head>
<body>

    <div class="header-row">
        <h1>ğŸ” æ™ºæ…§é–€ç¦ç³»çµ±</h1>
        <div class="mode-badge" onclick="switchMode()" id="modeBtn">åˆ‡æ›è‡³å¾Œå°</div>
    </div>

    <div id="user-section">
        <div class="card card-user">
            <h2>ğŸ‘¤ ä½¿ç”¨è€…é¢æ¿</h2>
            <div style="font-size: 1.2em; text-align: center; margin: 20px 0;">
                é–€é–ç‹€æ…‹: <span id="doorStatusUser" style="font-weight:bold">...</span>
            </div>
            
            <div id="confirm-modal">
                <h3>âš ï¸ é–‹é–€è«‹æ±‚ (Level 3)</h3>
                <p>åµæ¸¬åˆ°æ­£ç¢º RFIDï¼Œç­‰å¾…æ‚¨çš„æ‰¹å‡†...</p>
                <button class="btn btn-success" onclick="grantAccess()">æ‰¹å‡†é–‹é–€</button>
            </div>
        </div>
    </div>

    <div id="admin-section" style="display:none;">
        
        <div class="card card-admin" style="display:block">
            <h2>ğŸ® é ç«¯æ§åˆ¶</h2>
            <button class="btn btn-danger btn-big-toggle" onclick="remoteOpen()">ä¸€éµé–‹é–€ / é—œé–€</button>
        </div>

        <div class="card card-admin" style="display:block">
            <h2>ğŸ“Š ç³»çµ±è³‡è¨Š</h2>
            <div>é€£ç·šç‹€æ…‹: <span id="statusText">...</span></div>
            <div>ç›®å‰ç­‰ç´š: <span id="currentLevelTxt">...</span></div>
            <hr>
            <h3>ğŸ’³ å·²è¨»å†Š RFID</h3>
            <div id="uidListContainer"><small>è®€å–ä¸­...</small></div>
            <button class="btn btn-outline" style="margin-top:10px; font-size:0.8em" onclick="clearList('uid')">æ¸…ç©º RFID åå–®</button>
            
            <hr>
            <h3>ğŸ“± å·²ç¶å®šè—èŠ½</h3>
            <div id="btListContainer"><small>è®€å–ä¸­...</small></div>
            <button class="btn btn-outline" style="margin-top:10px; font-size:0.8em" onclick="clearList('bt')">æ¸…ç©ºè—èŠ½åå–®</button>
        </div>

        <div class="card card-admin" style="display:block">
            <h2>âš™ï¸ å®‰å…¨è¨­å®š</h2>
            
            <label>å®‰å…¨ç­‰ç´š:</label>
            <select id="levelSelect" style="width:100%; padding:10px; margin:10px 0;" onchange="updateLevel()">
                <option value="1">ç­‰ç´š 1: åƒ… RFID</option>
                <option value="2">ç­‰ç´š 2: RFID + è—èŠ½é©—è­‰</option>
                <option value="3">ç­‰ç´š 3: RFID + æ‰‹æ©Ÿç¢ºèª</option>
            </select>

            <hr>
            
            <label>æ–°å¢è—èŠ½è£ç½®:</label>
            <button class="btn btn-outline" onclick="scanBluetooth()">æƒæä¸¦æ–°å¢</button>
            <div id="bt-scan-list"></div>

            <hr>
            
            <label>æ–°å¢ RFID å¡ç‰‡:</label>
            <button class="btn btn-primary" id="regBtn" onclick="toggleRegisterMode()">é€²å…¥è¨»å†Šæ¨¡å¼</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBr9BNcRZItSaanoztoEO3NRLmXaYOvzHg",
            authDomain: "smart-door-8677e.firebaseapp.com",
            databaseURL: "https://smart-door-8677e-default-rtdb.firebaseio.com",
            projectId: "smart-door-8677e",
            storageBucket: "smart-door-8677e.firebasestorage.app",
            messagingSenderId: "846155740238",
            appId: "1:846155740238:web:797b890a695b71fc78ff1f",
            measurementId: "G-V17CK6E6X5"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        let currentUIDs = "";
        let currentBTs = "";

        // --- ä»‹é¢åˆ‡æ›é‚è¼¯ ---
        let isAdmin = false;
        function switchMode() {
            if (!isAdmin) {
                const pwd = prompt("è«‹è¼¸å…¥å¾Œå°å¯†ç¢¼:", "");
                if (pwd === "admin123") { // ç°¡æ˜“å¯†ç¢¼æª¢æŸ¥
                    isAdmin = true;
                    document.getElementById('user-section').style.display = 'none';
                    document.getElementById('admin-section').style.display = 'block';
                    document.getElementById('modeBtn').innerText = "åˆ‡æ›å›ä½¿ç”¨è€…";
                    document.getElementById('modeBtn').style.background = "#ffc107";
                } else {
                    alert("å¯†ç¢¼éŒ¯èª¤");
                }
            } else {
                isAdmin = false;
                document.getElementById('user-section').style.display = 'block';
                document.getElementById('admin-section').style.display = 'none';
                document.getElementById('modeBtn').innerText = "åˆ‡æ›è‡³å¾Œå°";
                document.getElementById('modeBtn').style.background = "#eee";
            }
        }

        // --- Firebase ç›£è½ ---
        
        // é–€é–ç‹€æ…‹
        db.ref('status/door_open').on('value', (s) => {
            const isOpen = s.val();
            const txt = isOpen ? "ğŸ”“ é–‹å•Ÿ" : "ğŸ”’ é—œé–‰";
            const color = isOpen ? "green" : "red";
            document.getElementById('doorStatusUser').innerText = txt;
            document.getElementById('doorStatusUser').style.color = color;
        });

        // Level 3 è«‹æ±‚
        db.ref('status/request_access').on('value', s => {
            document.getElementById('confirm-modal').style.display = s.val() ? 'block' : 'none';
        });

        // RFID åå–®é¡¯ç¤º
        db.ref('config/authorized_uids_list').on('value', (s) => {
            currentUIDs = s.val() || "";
            renderList(currentUIDs, 'uidListContainer');
        });

        // è—èŠ½åå–®é¡¯ç¤º
        db.ref('config/authorized_bt_macs_list').on('value', (s) => {
            currentBTs = s.val() || "";
            renderList(currentBTs, 'btListContainer');
        });

        // ç³»çµ±è¨­å®šç‹€æ…‹
        db.ref('config/security_level').on('value', s => {
            document.getElementById('levelSelect').value = s.val();
            document.getElementById('currentLevelTxt').innerText = s.val();
        });
        
        db.ref('config/system_mode').on('value', s => {
            const btn = document.getElementById('regBtn');
            if (s.val() === 'register') {
                btn.innerText = "ç­‰å¾…åˆ·å¡ä¸­...";
                btn.className = "btn btn-danger";
            } else {
                btn.innerText = "é€²å…¥è¨»å†Šæ¨¡å¼";
                btn.className = "btn btn-primary";
            }
        });

        db.ref('status/last_seen').on('value', s => {
             // é€™è£¡å¯ä»¥åšé€£ç·šæª¢æŸ¥ï¼Œç°¡åŒ–é¡¯ç¤º
             document.getElementById('statusText').innerText = "ESP32 åœ¨ç·š";
             document.getElementById('statusText').style.color = "green";
        });

        // --- åŠŸèƒ½å‡½å¼ ---

        // é ç«¯é–‹é–€
        function remoteOpen() {
            if(confirm("ç¢ºå®šè¦é ç«¯è§¸ç™¼é–€é–å—ï¼Ÿ")) {
                db.ref('cmd/remote_open').set(true);
            }
        }

        // æ‰¹å‡† Level 3
        function grantAccess() {
            db.ref('status/grant_access').set(true);
            document.getElementById('confirm-modal').style.display = 'none';
        }

        // æ›´æ–°ç­‰ç´š
        function updateLevel() {
            db.ref('config/security_level').set(parseInt(document.getElementById('levelSelect').value));
        }

        // è¨»å†Š RFID
        function toggleRegisterMode() {
            db.ref('config/system_mode').set('register');
        }

        // æ¸…ç©ºåå–®
        function clearList(type) {
            if(confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰åå–®å—ï¼Ÿ")) {
                const path = type === 'uid' ? 'config/authorized_uids_list' : 'config/authorized_bt_macs_list';
                db.ref(path).set("");
            }
        }

        // é¡¯ç¤ºæ¨™ç±¤å‡½å¼
        function renderList(str, elementId) {
            const container = document.getElementById(elementId);
            container.innerHTML = "";
            if (!str) { container.innerHTML = "<small>ç„¡è³‡æ–™</small>"; return; }
            str.split(',').forEach(item => {
                if(item) {
                    const tag = document.createElement('span');
                    tag.className = 'tag';
                    tag.innerText = item;
                    container.appendChild(tag);
                }
            });
        }

        // è—èŠ½æƒæèˆ‡æ–°å¢ (å¤šçµ„è¿½åŠ é‚è¼¯)
        function scanBluetooth() {
            const list = document.getElementById('bt-scan-list');
            list.style.display = 'none';
            db.ref('temp/bt_scan_results').remove();
            db.ref('cmd/scan_bt').set(true);
            alert("ESP32 æ­£åœ¨æƒæï¼Œè«‹ç¨å€™...");
            
            // ç›£è½æƒæçµæœ (ä¸€æ¬¡æ€§)
            db.ref('temp/bt_scan_results').once('value').then(() => {
                // é€™è£¡å…¶å¯¦æ‡‰è©²æŒçºŒç›£è½ï¼Œä½†ç‚ºäº†ç°¡åŒ–ï¼Œæˆ‘å€‘ç”¨åŸæœ¬çš„å…¨åŸŸç›£è½
            });
        }
        
        // ç›£è½æƒæçµæœå¡«å…¥åˆ—è¡¨
        db.ref('temp/bt_scan_results').on('value', s => {
            const devices = s.val();
            const list = document.getElementById('bt-scan-list');
            if(devices) {
                list.style.display = 'block';
                list.innerHTML = "";
                for (const k in devices) {
                    const d = devices[k];
                    const item = document.createElement('div');
                    item.className = 'bt-item';
                    item.innerHTML = `<span>${d.name || "æœªå‘½å"}</span><span>${d.mac}</span>`;
                    item.onclick = () => addBluetooth(d.mac);
                    list.appendChild(item);
                }
            }
        });

        function addBluetooth(newMac) {
            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
            if (currentBTs.includes(newMac)) {
                alert("æ­¤è£ç½®å·²åœ¨åå–®ä¸­");
                return;
            }
            if (confirm(`å°‡ ${newMac} åŠ å…¥é–‹é–€åå–®?`)) {
                let newList = currentBTs;
                if (newList.length > 0) newList += ",";
                newList += newMac;
                db.ref('config/authorized_bt_macs_list').set(newList);
                document.getElementById('bt-scan-list').style.display = 'none';
            }
        }

    </script>
</body>
</html>