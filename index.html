<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 æ™ºæ…§é–€ç¦æ§åˆ¶å°</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; background: #f4f6f9; color: #333; }
        h1, h2 { color: #2c3e50; }
        
        /* å¡ç‰‡å®¹å™¨æ¨£å¼ */
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; transition: transform 0.2s; }
        .card-admin { border-left: 5px solid #dc3545; display: none; } /* å¾Œå°é è¨­éš±è— */
        .card-user { border-left: 5px solid #28a745; }
        
        /* æ¨™é¡Œèˆ‡æŒ‰éˆ•æ’ç‰ˆ */
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .mode-badge { padding: 6px 12px; border-radius: 20px; font-size: 0.85em; font-weight: bold; background: #e2e6ea; cursor: pointer; color: #555;}
        .mode-badge:hover { background: #dbe2e8; }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 15px; width: 100%; margin-top: 5px; transition: 0.2s; font-weight: 500;}
        .btn:hover { filter: brightness(95%); }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        
        .btn-primary { background: #3498db; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-success { background: #2ecc71; color: white; }
        .btn-outline { background: transparent; border: 1px solid #3498db; color: #3498db; }
        .btn-outline:hover { background: #ebf5fb; }
        
        .btn-big { padding: 15px; font-size: 1.1em; margin-bottom: 10px; }
        
        /* ç‹€æ…‹æ¨™ç±¤ */
        .tag { display: inline-block; background: #e9ecef; padding: 4px 10px; border-radius: 12px; margin: 2px; font-size: 0.85em; border: 1px solid #dee2e6;}
        
        /* é–€é–èˆ‡é€£ç·šç‹€æ…‹æ¡† */
        .status-box { padding: 15px; border-radius: 8px; text-align: center; font-weight: bold; margin-bottom: 15px; font-size: 1.1em; display: flex; align-items: center; justify-content: center; gap: 10px;}
        .status-open { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-close { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        /* Log åˆ—è¡¨ */
        .log-entry { font-size: 0.9em; padding: 10px; border-bottom: 1px solid #f1f1f1; display: flex; justify-content: space-between; align-items: center; }
        .log-allow { background-color: #f0fff4; border-left: 3px solid #2ecc71; }
        .log-deny { background-color: #fff5f5; border-left: 3px solid #e74c3c; }

        /* Toast æç¤ºæ¡† */
        #toast { visibility: hidden; min-width: 280px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 12px 20px; position: fixed; z-index: 999; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        
        /* å½ˆå‡ºè¦–çª— */
        #confirm-modal { display: none; background: #fff3cd; color: #856404; padding: 15px; border-radius: 8px; border: 1px solid #ffeeba; margin-bottom: 20px; animation: pulse 2s infinite;}
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255, 193, 7, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); } }

        /* è—ç‰™æƒææ¸…å–® */
        #bt-scan-list { margin-top: 10px; max-height: 200px; overflow-y: auto; display: none; border: 1px solid #eee; border-radius: 6px; }
        .bt-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; background: #fff; }
        .bt-item:hover { background: #f8f9fa; }
    </style>
</head>
<body>

    <div id="toast">æç¤ºè¨Šæ¯</div>

    <div class="header-row">
        <h2>ğŸ” æ™ºæ…§é–€ç¦ç³»çµ±</h2>
        <div class="mode-badge" onclick="switchMode()" id="modeBtn">åˆ‡æ›è‡³å¾Œå°</div>
    </div>

    <div id="globalStatus" class="status-box status-close">
        <span id="doorIcon">ğŸ”’</span> 
        <span id="doorStatusText">è®€å–ä¸­...</span>
    </div>

    <div id="user-section">
        <div class="card card-user">
            <h3>ğŸ‘‹ è¨ªå®¢é¢æ¿</h3>
            <p style="text-align:center; color:#666; margin-bottom:20px;">è«‹æ„Ÿæ‡‰å¡ç‰‡ä»¥é€²å…¥</p>
            
            <div id="confirm-modal">
                <h3 style="margin:0 0 10px 0">âš ï¸ æ‰‹æ©Ÿç¢ºèªè«‹æ±‚</h3>
                <p>å·²åµæ¸¬åˆ° Level 3 æ¬Šé™å¡ç‰‡ï¼Œç­‰å¾…æ‚¨çš„æ‰¹å‡†...</p>
                <button class="btn btn-success" onclick="grantAccess()">æ‰¹å‡†é–‹é–€</button>
            </div>
        </div>
    </div>

    <div id="admin-section">
        
        <div class="card card-admin">
            <h3>ğŸ“¡ è£ç½®èˆ‡é€£ç·š</h3>
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span>é€£ç·šç‹€æ…‹: <span id="statusText">æª¢æŸ¥ä¸­...</span></span>
                <span style="font-size:0.85em; color:#888;">æœ€å¾Œè¨Šè™Ÿ: <span id="lastSeenTime">--</span></span>
            </div>
            <button class="btn btn-danger btn-big" onclick="remoteOpen()">ä¸€éµé–‹é–€ / é—œé–€</button>
        </div>

        <div class="card card-admin">
            <h3>ğŸ“‹ æœ€è¿‘é€²å‡ºç´€éŒ„</h3>
            <div id="logs-container" style="max-height: 250px; overflow-y: auto; border:1px solid #eee; border-radius:6px; margin-bottom:10px;">
                <div style="padding:20px; text-align:center; color:#999">è¼‰å…¥ä¸­...</div>
            </div>
            <button class="btn btn-outline" style="width:auto; float:right; font-size:0.8em; padding:5px 10px;" onclick="clearLogs()">æ¸…ç©ºç´€éŒ„</button>
            <div style="clear:both"></div>
        </div>

        <div class="card card-admin">
            <h3>âš™ï¸ å®‰å…¨èˆ‡æ¬Šé™è¨­å®š</h3>
            
            <label style="font-weight:bold; display:block; margin-bottom:5px;">
                ç›®å‰ç­‰ç´š: <span id="currentLevelTxt" style="color:#2980b9">è®€å–ä¸­...</span>
            </label>
            <div style="display:flex; gap:10px; margin-bottom: 20px;">
                <select id="levelSelect" style="flex:1; padding:8px; border-radius:4px; border:1px solid #ddd;">
                    <option value="1">Level 1: åƒ… RFID</option>
                    <option value="2">Level 2: RFID + è—ç‰™</option>
                    <option value="3">Level 3: RFID + æ‰‹æ©Ÿç¢ºèª</option>
                </select>
                <button class="btn btn-primary" style="width:auto; margin:0;" onclick="updateLevelManual()">è®Šæ›´</button>
            </div>

            <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
            
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h4>ğŸ’³ RFID åå–®</h4>
                <button class="btn btn-outline" style="width:auto; font-size:0.8em; padding:4px 8px;" onclick="clearList('uid')">æ¸…ç©º</button>
            </div>
            <div id="uidListContainer" style="margin-bottom:10px; min-height:30px;"><small>ç„¡è³‡æ–™</small></div>
            <button class="btn btn-primary" id="regBtn" onclick="toggleRegisterMode()">é€²å…¥è¨»å†Šæ¨¡å¼</button>
            
            <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
            
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h4>âŒš è—ç‰™è£ç½® (MAC)</h4>
                <button class="btn btn-outline" style="width:auto; font-size:0.8em; padding:4px 8px;" onclick="clearList('bt')">æ¸…ç©º</button>
            </div>
            <div id="btListContainer" style="margin-bottom:10px; min-height:30px; word-break: break-all;"><small>ç„¡è³‡æ–™</small></div>
            <button class="btn btn-outline" onclick="scanBluetooth()">æƒæä¸¦æ–°å¢</button>
            
            <div id="bt-scan-list"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // --- è«‹å¡«å…¥ä½ çš„ Firebase è¨­å®š ---
        const firebaseConfig = {
            apiKey: "AIzaSyBr9BNcRZItSaanoztoEO3NRLmXaYOvzHg",
            authDomain: "smart-door-8677e.firebaseapp.com",
            databaseURL: "https://smart-door-8677e-default-rtdb.firebaseio.com",
            projectId: "smart-door-8677e",
            storageBucket: "smart-door-8677e.firebasestorage.app",
            messagingSenderId: "846155740238",
            appId: "1:846155740238:web:797b890a695b71fc78ff1f",
            measurementId: "G-V17CK6E6X5"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        let currentBTs = "";
        let lastTs = 0; // é¿å…é‡è¤‡é¡¯ç¤º Toast

        // 1. åˆ‡æ›å‰å¾Œå° (å¯†ç¢¼ 123)
        let isAdmin = false;
        function switchMode() {
            if (!isAdmin) {
                const pwd = prompt("è«‹è¼¸å…¥å¾Œå°å¯†ç¢¼:", "");
                if (pwd === "123") { 
                    isAdmin = true;
                    document.getElementById('user-section').style.display = 'none';
                    document.querySelectorAll('.card-admin').forEach(el => el.style.display = 'block');
                    document.getElementById('modeBtn').innerText = "è¿”å›ä½¿ç”¨è€…";
                    document.getElementById('modeBtn').style.background = "#ffc107";
                } else if (pwd !== null) {
                    alert("å¯†ç¢¼éŒ¯èª¤");
                }
            } else {
                isAdmin = false;
                document.getElementById('user-section').style.display = 'block';
                document.querySelectorAll('.card-admin').forEach(el => el.style.display = 'none');
                document.getElementById('modeBtn').innerText = "åˆ‡æ›è‡³å¾Œå°";
                document.getElementById('modeBtn').style.background = "#e2e6ea";
            }
        }

        // 2. é–€é–ç‹€æ…‹ (UI åŒæ­¥)
        db.ref('status/door_open').on('value', (s) => {
            const isOpen = s.val();
            const box = document.getElementById('globalStatus');
            const txt = document.getElementById('doorStatusText');
            const icon = document.getElementById('doorIcon');
            
            if (isOpen) {
                box.className = "status-box status-open";
                txt.innerText = "å·²é–‹å•Ÿ";
                icon.innerText = "ğŸ”“";
            } else {
                box.className = "status-box status-close";
                txt.innerText = "å·²ä¸Šé–";
                icon.innerText = "ğŸ”’";
            }
        });

        // 3. åˆ·å¡å³æ™‚å›é¥‹ (Toast)
        db.ref('status/auth_latest').on('value', (s) => {
            const data = s.val();
            if (!data) return;
            if (data.ts && data.ts !== lastTs) {
                lastTs = data.ts;
                showToast(data.success, data.msg);
            }
        });

        function showToast(success, msg) {
            const x = document.getElementById("toast");
            x.innerText = (success ? "âœ… " : "âŒ ") + msg;
            x.style.backgroundColor = success ? "#2ecc71" : "#e74c3c";
            x.className = "show";
            setTimeout(() => { x.className = x.className.replace("show", ""); }, 3000);
        }

        // 4. é€²å‡ºç´€éŒ„ (Logs)
        db.ref('logs').limitToLast(15).on('value', (snapshot) => {
            const container = document.getElementById('logs-container');
            container.innerHTML = "";
            const logs = [];
            snapshot.forEach(child => logs.unshift(child.val())); 

            if (logs.length === 0) {
                container.innerHTML = "<div style='padding:20px; text-align:center; color:#999'>æš«ç„¡ç´€éŒ„</div>";
                return;
            }

            logs.forEach(log => {
                const div = document.createElement('div');
                const isAllow = (log.result === 'allow');
                div.className = `log-entry ${isAllow ? 'log-allow' : 'log-deny'}`;
                div.innerHTML = `
                    <div>
                        <strong>${isAllow ? 'å…è¨±' : 'æ‹’çµ•'}</strong> 
                        <span style="font-size:0.8em; color:#666; margin-left:5px;">(${log.type})</span>
                        <div style="font-size:0.8em; color:#888">UID: ${log.uid}</div>
                    </div>
                    <div style="text-align:right">
                        <small style="font-weight:bold">${log.msg}</small>
                    </div>
                `;
                container.appendChild(div);
            });
        });

        // 5. é€£ç·šç‹€æ…‹åˆ¤å®š (15ç§’è¶…æ™‚)
        let lastSeenTimestamp = 0;
        const statusTextEl = document.getElementById('statusText');
        const lastSeenEl = document.getElementById('lastSeenTime');

        db.ref('status/last_seen').on('value', () => {
            lastSeenTimestamp = Date.now();
            updateConnectionUI(0);
        });

        setInterval(() => {
            if (lastSeenTimestamp === 0) return;
            const diff = Math.floor((Date.now() - lastSeenTimestamp) / 1000);
            updateConnectionUI(diff);
        }, 1000);

        function updateConnectionUI(diff) {
            lastSeenEl.innerText = `${diff} ç§’å‰`;
            const controls = document.querySelectorAll('#admin-section button, #admin-section select');
            
            if (diff < 15) { 
                statusTextEl.innerHTML = "<span style='color:#2ecc71; font-weight:bold'>â— ç·šä¸Š</span>";
                controls.forEach(el => el.disabled = false);
            } else {
                statusTextEl.innerHTML = "<span style='color:#e74c3c; font-weight:bold'>âš ï¸ é›¢ç·š</span>";
                controls.forEach(el => el.disabled = true);
            }
        }

        // --- åŠŸèƒ½å‡½å¼ ---

        // å®‰å…¨ç­‰ç´š
        db.ref('config/security_level').on('value', s => {
            document.getElementById('currentLevelTxt').innerText = "Level " + s.val();
            document.getElementById('levelSelect').value = s.val();
        });
        
        function updateLevelManual() {
            const val = document.getElementById('levelSelect').value;
            if(confirm(`ç¢ºå®šå°‡å®‰å…¨ç­‰ç´šæ”¹ç‚º Level ${val} ?`)) {
                db.ref('config/security_level').set(parseInt(val));
                alert("æŒ‡ä»¤å·²ç™¼é€");
            }
        }

        // é ç«¯é–‹é–€
        function remoteOpen() {
            if(confirm("ç¢ºå®šè¦åŸ·è¡Œé ç«¯é–‹/é—œé–€ï¼Ÿ")) db.ref('cmd/remote_open').set(true);
        }

        // Level 3 æ‰¹å‡†
        db.ref('status/request_access').on('value', s => {
            document.getElementById('confirm-modal').style.display = s.val() ? 'block' : 'none';
        });
        function grantAccess() {
            db.ref('status/grant_access').set(true);
            document.getElementById('confirm-modal').style.display = 'none';
        }

        // è¨»å†Šæ¨¡å¼
        db.ref('config/system_mode').on('value', s => {
            const btn = document.getElementById('regBtn');
            if (s.val() === 'register') {
                btn.innerText = "â³ ç­‰å¾…æ„Ÿæ‡‰å¡ç‰‡...";
                btn.className = "btn btn-danger";
            } else {
                btn.innerText = "é€²å…¥è¨»å†Šæ¨¡å¼";
                btn.className = "btn btn-primary";
            }
        });
        function toggleRegisterMode() { db.ref('config/system_mode').set('register'); }

        // æ¸…é™¤è³‡æ–™
        function clearLogs() { if(confirm("æ¸…ç©ºç´€éŒ„ï¼Ÿ")) db.ref('logs').remove(); }
        function clearList(type) {
            if(confirm("ç¢ºå®šæ¸…ç©ºï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚")) {
                db.ref(type === 'uid' ? 'config/authorized_uids_list' : 'config/authorized_bt_macs_list').set("");
            }
        }

        // åˆ—è¡¨æ¸²æŸ“
        db.ref('config/authorized_uids_list').on('value', s => renderList(s.val(), 'uidListContainer'));
        db.ref('config/authorized_bt_macs_list').on('value', s => {
            currentBTs = s.val() || "";
            renderList(s.val(), 'btListContainer');
        });

        function renderList(str, elementId) {
            const container = document.getElementById(elementId);
            container.innerHTML = "";
            if (!str) { container.innerHTML = "<small style='color:#999'>ç„¡è³‡æ–™</small>"; return; }
            str.split(',').forEach(item => {
                if(item) {
                    const tag = document.createElement('span');
                    tag.className = 'tag';
                    tag.innerText = item;
                    container.appendChild(tag);
                }
            });
        }

        // è—ç‰™æƒæ
        function scanBluetooth() {
            document.getElementById('bt-scan-list').style.display = 'none';
            db.ref('temp/bt_scan_results').remove();
            db.ref('cmd/scan_bt').set(true);
            alert("ESP32 æ­£åœ¨æƒæ (éœ€ç´„5ç§’)ï¼Œè«‹ç¨å€™...");
        }

        db.ref('temp/bt_scan_results').on('value', s => {
            const devices = s.val();
            const list = document.getElementById('bt-scan-list');
            if(devices) {
                list.style.display = 'block';
                list.innerHTML = "";
                for (const k in devices) {
                    const d = devices[k];
                    const item = document.createElement('div');
                    item.className = 'bt-item';
                    item.innerHTML = `<span>${d.name || "æœªå‘½å"}</span><span style="font-family:monospace">${d.mac}</span>`;
                    item.onclick = () => addBluetooth(d.mac);
                    list.appendChild(item);
                }
            }
        });

        function addBluetooth(newMac) {
            // è‡ªå‹•ç§»é™¤å†’è™Ÿï¼Œç¢ºä¿æ ¼å¼çµ±ä¸€
            const cleanMac = newMac.replace(/:/g, '').toUpperCase();
            if (currentBTs.includes(cleanMac)) { alert("æ­¤è£ç½®å·²åœ¨åå–®ä¸­"); return; }
            
            if (confirm(`å°‡ ${newMac} (å„²å­˜ç‚º ${cleanMac}) åŠ å…¥åå–®?`)) {
                let newList = currentBTs;
                if (newList.length > 0) newList += ",";
                newList += cleanMac;
                db.ref('config/authorized_bt_macs_list').set(newList);
                document.getElementById('bt-scan-list').style.display = 'none';
            }
        }
    </script>
</body>
</html>