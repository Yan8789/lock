<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 æ™ºæ…§é–€ç¦</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; background: #f0f2f5; color: #333; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card-admin { border-left: 5px solid #dc3545; display: none; } /* é è¨­éš±è—å¾Œå° */
        .card-user { border-left: 5px solid #28a745; }
        h2 { margin-top: 0; font-size: 1.2em; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .mode-badge { padding: 5px 10px; border-radius: 15px; font-size: 0.8em; font-weight: bold; background: #eee; cursor: pointer;}
        
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; margin: 5px 0; width: 100%; transition: 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; background-color: #ccc; }
        
        .btn-primary { background: #007bff; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-outline { background: transparent; border: 1px solid #007bff; color: #007bff; }
        .btn-big-toggle { font-size: 1.2em; font-weight: bold; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        .tag { display: inline-block; background: #e9ecef; padding: 5px 10px; border-radius: 15px; margin: 3px; font-size: 0.9em; border: 1px solid #ced4da;}
        
        /* ç‹€æ…‹ç›’æ¨£å¼ */
        .status-box { padding: 15px; border-radius: 8px; text-align: center; font-weight: bold; margin-bottom: 15px; font-size: 1.1em;}
        .status-open { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-close { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        /* Logs æ¨£å¼ */
        .log-entry { font-size: 0.9em; padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .log-allow { border-left: 4px solid #28a745; background: #f0fff4; }
        .log-deny { border-left: 4px solid #dc3545; background: #fff0f0; }

        /* Toast æ¨£å¼ */
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 100; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 17px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        
        #confirm-modal { display: none; background: #fff3cd; color: #856404; padding: 15px; border-radius: 8px; border: 1px solid #ffeeba; animation: blink 1s infinite; margin-bottom: 20px;}
        @keyframes blink { 50% { border-color: transparent; } }

        #bt-scan-list { margin-top: 10px; max-height: 200px; overflow-y: auto; display: none; border: 1px solid #eee; }
        .bt-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; }
        .bt-item:hover { background: #f8f9fa; }
    </style>
</head>
<body>

    <div id="toast">æç¤ºè¨Šæ¯</div>

    <div class="header-row">
        <h1>ğŸ” æ™ºæ…§é–€ç¦ç³»çµ±</h1>
        <div class="mode-badge" onclick="switchMode()" id="modeBtn">åˆ‡æ›è‡³å¾Œå°</div>
    </div>

    <div id="globalStatus" class="status-box status-close">
        é–€é–ç‹€æ…‹: <span id="doorStatusText">è®€å–ä¸­...</span>
    </div>

    <div id="user-section">
        <div class="card card-user">
            <h2>ğŸ‘¤ ä½¿ç”¨è€…é¢æ¿</h2>
            <p style="text-align:center; color:#666;">è«‹åˆ·å¡é€²å…¥ã€‚è‹¥éœ€ç®¡ç†åŠŸèƒ½è«‹åˆ‡æ›è‡³å¾Œå°ã€‚</p>
            
            <div id="confirm-modal">
                <h3>âš ï¸ é–‹é–€è«‹æ±‚ (Level 3)</h3>
                <p>åµæ¸¬åˆ°æ­£ç¢º RFIDï¼Œç­‰å¾…æ‚¨çš„æ‰¹å‡†...</p>
                <button class="btn btn-success" onclick="grantAccess()">æ‰¹å‡†é–‹é–€</button>
            </div>
        </div>
    </div>

    <div id="admin-section">
        
        <div class="card card-admin">
            <h2>ğŸ® é ç«¯æ§åˆ¶ & ç›£æ§</h2>
            <div style="margin-bottom: 10px;">
                ESP32 é€£ç·š: <span id="statusText">æª¢æŸ¥ä¸­...</span>
                <span style="font-size:0.8em; color:#999; margin-left:10px;">(æœ€å¾Œè¨Šè™Ÿ: <span id="lastSeenTime">--</span>)</span>
            </div>
            <button class="btn btn-danger btn-big-toggle" onclick="remoteOpen()">ä¸€éµé–‹é–€ / é—œé–€</button>
        </div>

        <div class="card card-admin">
            <h2>ğŸ“ æœ€è¿‘é€²å‡ºç´€éŒ„ (Logs)</h2>
            <div id="logs-container" style="max-height: 300px; overflow-y: auto; border:1px solid #eee; border-radius:8px;">
                <div style="padding:20px; text-align:center; color:#999">è¼‰å…¥ä¸­...</div>
            </div>
            <button class="btn btn-outline" onclick="clearLogs()" style="margin-top:10px; font-size:0.8em;">æ¸…ç©ºç´€éŒ„</button>
        </div>

        <div class="card card-admin">
            <h2>âš™ï¸ å®‰å…¨è¨­å®š</h2>
            
            <label>å®‰å…¨ç­‰ç´š (ç›®å‰: <span id="currentLevelTxt">-</span>)</label>
            <select id="levelSelect" style="width:100%; padding:10px; margin:5px 0;" onchange="updateLevel()">
                <option value="1">Level 1: åƒ… RFID</option>
                <option value="2">Level 2: RFID + è—ç‰™é©—è­‰</option>
                <option value="3">Level 3: RFID + æ‰‹æ©Ÿç¢ºèª</option>
            </select>

            <hr>
            
            <h3>ğŸ’³ RFID ç®¡ç†</h3>
            <div id="uidListContainer"><small>è®€å–ä¸­...</small></div>
            <button class="btn btn-primary" id="regBtn" onclick="toggleRegisterMode()">é€²å…¥è¨»å†Šæ¨¡å¼</button>
            <button class="btn btn-outline" style="margin-top:5px; font-size:0.8em; float:right;" onclick="clearList('uid')">æ¸…ç©ºåå–®</button>
            <div style="clear:both"></div>
            
            <hr>
            
            <h3>ğŸ“± è—ç‰™è£ç½® (MAC)</h3>
            <div id="btListContainer"><small>è®€å–ä¸­...</small></div>
            <button class="btn btn-outline" onclick="scanBluetooth()">æƒæä¸¦æ–°å¢è—ç‰™</button>
            <button class="btn btn-outline" style="margin-top:5px; font-size:0.8em; float:right;" onclick="clearList('bt')">æ¸…ç©ºåå–®</button>
            <div style="clear:both"></div>
            <div id="bt-scan-list"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // --- è«‹å°‡æ­¤è™•æ›¿æ›ç‚ºä½ çš„ Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyBr9BNcRZItSaanoztoEO3NRLmXaYOvzHg",
            authDomain: "smart-door-8677e.firebaseapp.com",
            databaseURL: "https://smart-door-8677e-default-rtdb.firebaseio.com",
            projectId: "smart-door-8677e",
            storageBucket: "smart-door-8677e.firebasestorage.app",
            messagingSenderId: "846155740238",
            appId: "1:846155740238:web:797b890a695b71fc78ff1f",
            measurementId: "G-V17CK6E6X5"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        let currentUIDs = "";
        let currentBTs = "";
        let lastTs = 0; // ç”¨æ–¼é¿å…é‡è¤‡é¡¯ç¤º Toast

        // --- 1. ä»‹é¢åˆ‡æ›é‚è¼¯ ---
        let isAdmin = false;
        function switchMode() {
            if (!isAdmin) {
                const pwd = prompt("è«‹è¼¸å…¥å¾Œå°å¯†ç¢¼:", "");
                if (pwd === "123") { // ç°¡æ˜“å¯†ç¢¼æª¢æŸ¥
                    isAdmin = true;
                    document.getElementById('user-section').style.display = 'none';
                    // é¡¯ç¤ºæ‰€æœ‰ class ç‚º card-admin çš„å…ƒç´ 
                    const admins = document.querySelectorAll('.card-admin');
                    admins.forEach(el => el.style.display = 'block');
                    
                    document.getElementById('modeBtn').innerText = "åˆ‡æ›å›ä½¿ç”¨è€…";
                    document.getElementById('modeBtn').style.background = "#ffc107";
                } else {
                    alert("å¯†ç¢¼éŒ¯èª¤");
                }
            } else {
                isAdmin = false;
                document.getElementById('user-section').style.display = 'block';
                const admins = document.querySelectorAll('.card-admin');
                admins.forEach(el => el.style.display = 'none');
                
                document.getElementById('modeBtn').innerText = "åˆ‡æ›è‡³å¾Œå°";
                document.getElementById('modeBtn').style.background = "#eee";
            }
        }

        // --- 2. é–€é–ç‹€æ…‹ç›£è½ (UI åŒæ­¥) ---
        db.ref('status/door_open').on('value', (s) => {
            const isOpen = s.val();
            const box = document.getElementById('globalStatus');
            const txt = document.getElementById('doorStatusText');
            if (isOpen) {
                box.className = "status-box status-open";
                txt.innerText = "ğŸ”“ é–‹å•Ÿ";
            } else {
                box.className = "status-box status-close";
                txt.innerText = "ğŸ”’ é—œé–‰";
            }
        });

        // --- 3. åˆ·å¡å³æ™‚å›é¥‹ (Toast) ---
        db.ref('status/auth_latest').on('value', (s) => {
            const data = s.val();
            if (!data) return;
            // æª¢æŸ¥æ˜¯å¦æ˜¯æ–°è¨Šæ¯
            if (data.ts && data.ts !== lastTs) {
                lastTs = data.ts;
                showToast(data.success, data.msg);
            }
        });

        function showToast(success, msg) {
            const x = document.getElementById("toast");
            x.innerText = (success ? "âœ… " : "âŒ ") + msg;
            x.style.backgroundColor = success ? "#28a745" : "#dc3545";
            x.className = "show";
            setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
        }

        // --- 4. é€²å‡ºç´€éŒ„ (Logs) ç›£è½ ---
        db.ref('logs').limitToLast(20).on('value', (snapshot) => {
            const container = document.getElementById('logs-container');
            container.innerHTML = "";
            const logs = [];
            snapshot.forEach(child => logs.unshift(child.val())); // åè½‰é †åºï¼Œæ–°çš„åœ¨ä¸Šé¢

            if (logs.length === 0) {
                container.innerHTML = "<div style='padding:20px; text-align:center; color:#999'>æš«ç„¡ç´€éŒ„</div>";
                return;
            }

            logs.forEach(log => {
                const div = document.createElement('div');
                const isAllow = (log.result === 'allow');
                div.className = `log-entry ${isAllow ? 'log-allow' : 'log-deny'}`;
                div.innerHTML = `
                    <div>
                        <strong>${isAllow ? 'å…è¨±' : 'æ‹’çµ•'}</strong> 
                        <span style="font-size:0.8em; color:#666">(${log.type})</span><br>
                        <small style="color:#888">UID: ${log.uid}</small>
                    </div>
                    <div style="text-align:right">
                        <small style="font-weight:bold">${log.msg}</small>
                    </div>
                `;
                container.appendChild(div);
            });
        });

        // --- 5. é€£ç·šç‹€æ…‹åˆ¤å®š (ä¿®æ­£ç‰ˆ) ---
        let lastSeenTimestamp = 0;
        const statusTextEl = document.getElementById('statusText');
        const lastSeenEl = document.getElementById('lastSeenTime');

        db.ref('status/last_seen').on('value', s => {
            // ç•¶è³‡æ–™åº«æœ‰è®Šå‹•æ™‚ï¼Œæ›´æ–°æœ¬åœ°è¨ˆæ™‚åŸºæº–
            lastSeenTimestamp = Date.now();
            updateConnectionUI(0);
        });

        // æ¯ç§’æª¢æŸ¥ä¸€æ¬¡
        setInterval(() => {
            if (lastSeenTimestamp === 0) return;
            const diff = Math.floor((Date.now() - lastSeenTimestamp) / 1000);
            updateConnectionUI(diff);
        }, 1000);

        function updateConnectionUI(diff) {
            lastSeenEl.innerText = `${diff} ç§’å‰`;
            const adminControls = document.querySelectorAll('#admin-section button, #admin-section select');
            
            if (diff < 15) { // 15ç§’å…§æœ‰è¨Šè™Ÿç®—åœ¨ç·š
                statusTextEl.innerHTML = "<span style='color:green; font-weight:bold'>â— ç·šä¸Š</span>";
                adminControls.forEach(el => el.disabled = false);
            } else {
                statusTextEl.innerHTML = "<span style='color:red; font-weight:bold'>âš ï¸ é›¢ç·š</span>";
                adminControls.forEach(el => el.disabled = true);
            }
        }

        // --- å…¶ä»–åŠŸèƒ½å‡½å¼ ---

        // Level 3 è«‹æ±‚ç›£è½
        db.ref('status/request_access').on('value', s => {
            document.getElementById('confirm-modal').style.display = s.val() ? 'block' : 'none';
        });

        function grantAccess() {
            db.ref('status/grant_access').set(true);
            document.getElementById('confirm-modal').style.display = 'none';
        }

        function remoteOpen() {
            if(confirm("ç¢ºå®šè¦é ç«¯æ“ä½œé–€é–å—ï¼Ÿ")) {
                db.ref('cmd/remote_open').set(true);
            }
        }

        function updateLevel() {
            db.ref('config/security_level').set(parseInt(document.getElementById('levelSelect').value));
        }

        function toggleRegisterMode() {
            db.ref('config/system_mode').set('register');
        }

        function clearLogs() {
            if(confirm("ç¢ºå®šæ¸…ç©ºæ‰€æœ‰ç´€éŒ„ï¼Ÿ")) db.ref('logs').remove();
        }
        
        function clearList(type) {
            if(confirm("ç¢ºå®šæ¸…ç©ºåå–®ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚")) {
                const path = type === 'uid' ? 'config/authorized_uids_list' : 'config/authorized_bt_macs_list';
                db.ref(path).set("");
            }
        }

        // ç›£è½ä¸¦é¡¯ç¤ºè¨­å®šå€¼
        db.ref('config/security_level').on('value', s => {
            document.getElementById('levelSelect').value = s.val();
            document.getElementById('currentLevelTxt').innerText = s.val();
        });

        db.ref('config/system_mode').on('value', s => {
            const btn = document.getElementById('regBtn');
            if (s.val() === 'register') {
                btn.innerText = "ç­‰å¾…åˆ·å¡ä¸­...";
                btn.className = "btn btn-danger";
            } else {
                btn.innerText = "é€²å…¥è¨»å†Šæ¨¡å¼";
                btn.className = "btn btn-primary";
            }
        });

        // åˆ—è¡¨æ¸²æŸ“
        db.ref('config/authorized_uids_list').on('value', (s) => renderList(s.val(), 'uidListContainer'));
        db.ref('config/authorized_bt_macs_list').on('value', (s) => {
            currentBTs = s.val() || "";
            renderList(s.val(), 'btListContainer');
        });

        function renderList(str, elementId) {
            const container = document.getElementById(elementId);
            container.innerHTML = "";
            if (!str) { container.innerHTML = "<small>ç„¡è³‡æ–™</small>"; return; }
            str.split(',').forEach(item => {
                if(item) {
                    const tag = document.createElement('span');
                    tag.className = 'tag';
                    tag.innerText = item;
                    container.appendChild(tag);
                }
            });
        }

        // è—ç‰™æƒæ
        function scanBluetooth() {
            const list = document.getElementById('bt-scan-list');
            list.style.display = 'none';
            db.ref('temp/bt_scan_results').remove();
            db.ref('cmd/scan_bt').set(true);
            alert("ESP32 æ­£åœ¨æƒæ (éœ€ç´„5ç§’)ï¼Œè«‹ç¨å€™...");
        }

        db.ref('temp/bt_scan_results').on('value', s => {
            const devices = s.val();
            const list = document.getElementById('bt-scan-list');
            if(devices) {
                list.style.display = 'block';
                list.innerHTML = "";
                for (const k in devices) {
                    const d = devices[k];
                    const item = document.createElement('div');
                    item.className = 'bt-item';
                    item.innerHTML = `<span>${d.name || "æœªå‘½å"}</span><span>${d.mac}</span>`;
                    item.onclick = () => addBluetooth(d.mac);
                    list.appendChild(item);
                }
            }
        });

        function addBluetooth(newMac) {
            if (currentBTs.includes(newMac)) { alert("æ­¤è£ç½®å·²åœ¨åå–®ä¸­"); return; }
            if (confirm(`å°‡ ${newMac} åŠ å…¥é–‹é–€åå–®?`)) {
                let newList = currentBTs;
                if (newList.length > 0) newList += ",";
                newList += newMac;
                db.ref('config/authorized_bt_macs_list').set(newList);
                document.getElementById('bt-scan-list').style.display = 'none';
            }
        }
    </script>
</body>
</html>